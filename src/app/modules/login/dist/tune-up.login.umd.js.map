{"version":3,"file":"tune-up.login.umd.js","sources":["../src/config/validations.js","../src/config/config.js","../src/services/login.service.js","../src/services/sites.service.js","../src/login.component.js","../src/login.routing.js","../src/components/siteselector/siteselector.component.js","../src/login.module.js"],"sourcesContent":["export const validations = {\n  login: {\n    email: [\n      {\n        isEmail: {\n          message: 'Debe ser un email válido',\n        },\n      },\n      {\n        required: {\n          message: 'El email es requerido',\n        },\n      },\n    ],\n    password: [\n      {\n        required: {\n          message: 'La contraseña es requerida',\n        },\n      },\n    ],\n  },\n};\n","import {configService} from '@tune-up/core';\nimport {validations} from './validations';\n\nconfigService.addValidations(validations);\n","import {Injectable} from '@angular/core';\nimport {HttpClient} from '@angular/common/http';\n\n@Injectable()\nexport class LoginService {\n  constructor(http: HttpClient) {\n    this._http = http;\n    this._url = 'Login2';\n  }\n  login(model) {\n    return this._http.post(this._url, model);\n  }\n}\n","import {Injectable} from '@angular/core';\nimport {HttpClient} from '@angular/common/http';\n\n@Injectable()\nexport class SitesService {\n  constructor(http: HttpClient) {\n    this._http = http;\n    this._url = 'Sitios';\n  }\n  get(email) {\n    return this._http.get(`${this._url}\\\\${email}`);\n  }\n}\n","import {Router, ActivatedRoute} from '@angular/router';\nimport {Component, ViewChild} from '@angular/core';\nimport {AuthService, AgentService, AboutService} from '@tune-up/app';\nimport {NotificationsService} from '@tune-up/core';\nimport {LoginService, SitesService} from './services';\nimport html from './login.component.html';\nimport './login.component.css';\n\n@Component({\n  selector: 'tn-login',\n  template: html,\n  providers: [LoginService, SitesService],\n})\nexport class LoginComponent {\n  model = {\n    email: undefined,\n    password: undefined,\n    idsitio: undefined,\n  };\n  sites = [];\n  _returnUrl = '/home';\n  @ViewChild('emailCtrl') emailCtrl;\n  constructor(\n    route: ActivatedRoute,\n    router: Router,\n    loginService: LoginService,\n    sitesService: SitesService,\n    authService: AuthService,\n    agentService: AgentService,\n    aboutService: AboutService,\n    notificationsService: NotificationsService\n  ) {\n    this._route = route;\n    this._router = router;\n    this._loginService = loginService;\n    this._sitesService = sitesService;\n    this._authService = authService;\n    this._aboutService = aboutService;\n    this._agentService = agentService;\n    this._notificationsService = notificationsService;\n  }\n  ngOnInit() {\n    this._setDefaulReturnUrl();\n    this._checkLogedIn();\n  }\n  _setDefaulReturnUrl() {\n    const paramsReturnUrl = this._route.snapshot.queryParams.returnUrl;\n    this._returnUrl =\n      !paramsReturnUrl ||\n        paramsReturnUrl === '/login' ||\n        paramsReturnUrl === '/'\n        ? this._returnUrl\n        : paramsReturnUrl;\n  }\n  _checkLogedIn() {\n    if (this._authService.getToken()) {\n      this._redirect();\n    }\n  }\n  _redirect() {\n    this._router.navigateByUrl(this._returnUrl);\n  }\n  onEmailFocusLost = () => {\n    if (!this.model.email || !this.emailCtrl.valid) {\n      return;\n    }\n    this._getSitesSubscription = this._sitesService.get(this.model.email).subscribe(\n      (data) => {\n        this._handleNoSites(data);\n        data.length > 0 && this._parseSites(data);\n      },\n      (error) => {\n        this._notificationsService.error('No se pudieron encontrar sitios', error);\n      }\n    );\n  };\n  _handleNoSites(sites) {\n    sites.length === 0 &&\n      this._notificationsService.error(\n        'No hay sitios disponibles',\n        'No existen sitios asociados con este email.'\n      );\n  }\n  _parseSites(sites) {\n    this.sites = sites.map((site) => {\n      return {label: site.Nombre, value: site.Id};\n    });\n    this.model.idsitio = sites[0] && sites[0].Id;\n  }\n  login = () => {\n    this._loginSubscription = this._loginService.login(this.model).subscribe(\n      (data) => {\n        let {Token, Agente, Configuracion} = data;\n        Agente.IdSitio = this.model.idsitio;\n        this._authService.setToken(Token);\n        this._agentService.agent = Agente;\n        this._aboutService.about = Configuracion;\n        this._redirect();\n      },\n      (error) => {\n        this._notificationsService.error('Error de login', error);\n      }\n    );\n  };\n  setIdSitio = (idSitio) => {\n    this.model.idsitio = idSitio;\n  };\n  showSelector = () => {\n    return this.sites.length > 1;\n  };\n  ngOnDestroy() {\n    this._getSitesSubscription &&\n      !this._getSitesSubscription.closed &&\n      this._getSitesSubscription.unsubscribe();\n    this._loginSubscription &&\n      !this._loginSubscription.closed &&\n      this._loginSubscription.unsubscribe();\n  }\n}\n","import {RouterModule} from '@angular/router';\nimport {NgModule} from '@angular/core';\nimport {LoginComponent} from './login.component';\n\n@NgModule({\n  imports: [RouterModule.forChild([{path: '', component: LoginComponent}])],\n  exports: [RouterModule],\n})\nexport class LoginRoutingModule {}\n","import {Component, Input, Output, EventEmitter} from '@angular/core';\nimport html from './siteselector.component.html';\n\n@Component({\n  selector: 'tn-site-selector',\n  template: html,\n})\nexport class SiteSelectorComponent {\n  @Input() sites = [];\n  @Output() onSiteSelected = new EventEmitter();\n  selectSite = (event) => {\n    this.onSiteSelected.emit(event.value);\n  };\n}\n","import {NgModule} from '@angular/core';\nimport {LoginRoutingModule} from './login.routing';\nimport {LoginComponent} from './login.component';\nimport {SiteSelectorComponent} from './components';\nimport {TuneUpCoreModule} from '@tune-up/core';\n\n@NgModule({\n  imports: [TuneUpCoreModule, LoginRoutingModule],\n  declarations: [LoginComponent, SiteSelectorComponent],\n})\nexport class LoginModule {}\n"],"names":["validations","configService","addValidations","LoginService","Injectable","http","_http","_url","model","this","post","HttpClient","SitesService","email","get","LoginComponent","Component","ViewChild","route","router","loginService","sitesService","authService","agentService","aboutService","notificationsService","undefined","sites","_returnUrl","onEmailFocusLost","_this","emailCtrl","valid","_getSitesSubscription","_sitesService","subscribe","data","_handleNoSites","length","_parseSites","error","_notificationsService","login","_loginSubscription","_loginService","Token","Agente","Configuracion","IdSitio","idsitio","_authService","setToken","_agentService","agent","_aboutService","about","_redirect","setIdSitio","idSitio","showSelector","_route","_router","_setDefaulReturnUrl","_checkLogedIn","paramsReturnUrl","snapshot","queryParams","returnUrl","getToken","navigateByUrl","map","site","label","Nombre","value","Id","closed","unsubscribe","ActivatedRoute","Router","AuthService","AgentService","AboutService","NotificationsService","LoginRoutingModule","NgModule","RouterModule","forChild","path","component","SiteSelectorComponent","Input","Output","selectSite","event","onSiteSelected","emit","EventEmitter","LoginModule","TuneUpCoreModule"],"mappings":"61CAAO,IAAMA,mCAKM,gDAKA,wDAOA,kCCdnBC,gBAAcC,eAAeF,u6CCChBG,KADZC,mDAEaC,6BACLC,MAAQD,OACRE,KAAO,kEAERC,UACGC,KAAKH,MAAMI,KAAKD,KAAKF,KAAMC,uEALlBG,cADPR,WCAAS,KADZR,mDAEaC,6BACLC,MAAQD,OACRE,KAAO,iEAEVM,UACKJ,KAAKH,MAAMQ,IAAOL,KAAKF,UAASM,uEALvBF,cADPC,4gCCSAG,KALZC,sBACW,08CAEEb,EAAcS,OAUzBK,YAAU,qDAETC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,0CAhBFjB,kBACSkB,gBACGA,eACDA,QAEXC,cACAC,WAAa,sDA0CbC,iBAAmB,WACZC,EAAKtB,MAAMK,OAAUiB,EAAKC,UAAUC,UAGpCC,sBAAwBH,EAAKI,cAAcpB,IAAIgB,EAAKtB,MAAMK,OAAOsB,UACpE,SAACC,KACMC,eAAeD,KACfE,OAAS,GAAKR,EAAKS,YAAYH,IAEtC,SAACI,KACMC,sBAAsBD,MAAM,kCAAmCA,YAiB1EE,MAAQ,aACDC,mBAAqBb,EAAKc,cAAcF,MAAMZ,EAAKtB,OAAO2B,UAC7D,SAACC,OACMS,EAAgCT,EAAhCS,MAAOC,EAAyBV,EAAzBU,OAAQC,EAAiBX,EAAjBW,gBACbC,QAAUlB,EAAKtB,MAAMyC,UACvBC,aAAaC,SAASN,KACtBO,cAAcC,MAAQP,IACtBQ,cAAcC,MAAQR,IACtBS,aAEP,SAAChB,KACMC,sBAAsBD,MAAM,iBAAkBA,WAIzDiB,WAAa,SAACC,KACPlD,MAAMyC,QAAUS,QAEvBC,aAAe,kBACN7B,EAAKH,MAAMW,OAAS,QA5EtBsB,OAAS1C,OACT2C,QAAU1C,OACVyB,cAAgBxB,OAChBc,cAAgBb,OAChB6B,aAAe5B,OACfgC,cAAgB9B,OAChB4B,cAAgB7B,OAChBkB,sBAAwBhB,0EAGxBqC,2BACAC,sFAGCC,EAAkBvD,KAAKmD,OAAOK,SAASC,YAAYC,eACpDvC,WACFoC,GACqB,WAApBA,GACoB,MAApBA,EAEEA,EADAvD,KAAKmB,iEAIPnB,KAAKyC,aAAakB,iBACfZ,+DAIFK,QAAQQ,cAAc5D,KAAKmB,kEAgBnBD,GACI,MAAXW,QACJ7B,KAAKgC,sBAAsBD,MACzB,4BACA,+FAGMb,QACLA,MAAQA,EAAM2C,IAAI,SAACC,UACdC,MAAOD,EAAKE,OAAQC,MAAOH,EAAKI,WAErCnE,MAAMyC,QAAUtB,EAAM,IAAMA,EAAM,GAAGgD,0DAwBrC1C,wBACFxB,KAAKwB,sBAAsB2C,QAC5BnE,KAAKwB,sBAAsB4C,mBACxBlC,qBACFlC,KAAKkC,mBAAmBiC,QACzBnE,KAAKkC,mBAAmBkC,+jBA/FJ9C,mEAEf+C,iBACCC,SACM5E,EACAS,EACDoE,cACCC,eACAC,eACQC,wBAjBbpE,6BCLAqE,KAJZC,qBACWC,eAAaC,WAAWC,KAAM,GAAIC,UAAW1E,eAC7CuE,mFCCCI,KAJZ1E,sBACW,gIAIT2E,YACAC,sLACDC,WAAa,SAACC,KACPC,eAAeC,KAAKF,EAAMpB,qPAFN,IAAIuB,4BCCpBC,KAJZb,qBACWc,mBAAkBf,iBACbrE,EAAgB2E"}