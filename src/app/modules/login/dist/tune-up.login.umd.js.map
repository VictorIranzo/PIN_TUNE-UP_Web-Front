{"version":3,"file":"tune-up.login.umd.js","sources":["../src/config/validations.js","../src/config/config.js","../src/services/login.service.js","../src/services/sites.service.js","../src/login.component.js","../src/login.routing.js","../src/components/siteselector/siteselector.component.js","../src/login.module.js"],"sourcesContent":["export const validations = {\n  login: {\n    email: [\n      {\n        isEmail: {\n          message: 'Debe ser un email v치lido',\n        },\n      },\n      {\n        required: {\n          message: 'El email es requerido',\n        },\n      },\n    ],\n    password: [\n      {\n        required: {\n          message: 'La contrase침a es requerida',\n        },\n      },\n    ],\n  },\n};\n","import {configService} from '@tune-up/core';\nimport {validations} from './validations';\n\nconfigService.addValidations(validations);\n","import {Injectable} from '@angular/core';\nimport {HttpClient} from '@angular/common/http';\n\n@Injectable()\nexport class LoginService {\n  constructor(http: HttpClient) {\n    this._http = http;\n    this._url = 'Login2';\n  }\n  login(model) {\n    return this._http.post(this._url, model);\n  }\n}\n","import {Injectable} from '@angular/core';\nimport {HttpClient} from '@angular/common/http';\n\n@Injectable()\nexport class SitesService {\n  constructor(http: HttpClient) {\n    this._http = http;\n    this._url = 'Sitios';\n  }\n  get(email) {\n    return this._http.get(`${this._url}\\\\${email}`);\n  }\n}\n","import {Router, ActivatedRoute} from '@angular/router';\nimport {Component, ViewChild} from '@angular/core';\nimport {AuthService, AgentService, AboutService} from '@tune-up/app';\nimport {NotificationsService} from '@tune-up/core';\nimport {LoginService, SitesService} from './services';\nimport html from './login.component.html';\nimport './login.component.css';\n\n@Component({\n  selector: 'tn-login',\n  template: html,\n  providers: [LoginService, SitesService],\n})\nexport class LoginComponent {\n  model = {\n    email: undefined,\n    password: undefined,\n    idsitio: undefined,\n  };\n  sites = [];\n  loginInProgress = false;\n  _returnUrl = '/home';\n  @ViewChild('emailCtrl') emailCtrl;\n  constructor(\n    route: ActivatedRoute,\n    router: Router,\n    loginService: LoginService,\n    sitesService: SitesService,\n    authService: AuthService,\n    agentService: AgentService,\n    aboutService: AboutService,\n    notificationsService: NotificationsService\n  ) {\n    this._route = route;\n    this._router = router;\n    this._loginService = loginService;\n    this._sitesService = sitesService;\n    this._authService = authService;\n    this._aboutService = aboutService;\n    this._agentService = agentService;\n    this._notificationsService = notificationsService;\n  }\n  ngOnInit() {\n    this._setDefaulReturnUrl();\n    this._checkLogedIn();\n  }\n  _setDefaulReturnUrl() {\n    const paramsReturnUrl = this._route.snapshot.queryParams.returnUrl;\n    this._returnUrl =\n      !paramsReturnUrl ||\n        paramsReturnUrl === '/login' ||\n        paramsReturnUrl === '/'\n        ? this._returnUrl\n        : paramsReturnUrl;\n  }\n  _checkLogedIn() {\n    if (this._authService.getToken()) {\n      this._redirect();\n    }\n  }\n  _redirect() {\n    this._router.navigateByUrl(this._returnUrl);\n  }\n  onEmailFocusLost = () => {\n    if (!this.model.email || !this.emailCtrl.valid) {\n      return;\n    }\n    this._getSitesSubscription = this._sitesService.get(this.model.email).subscribe(\n      (data) => {\n        data.length > 0 && this._parseSites(data);\n      },\n      (error) => {\n        this._notificationsService.error('No se pudieron encontrar sitios', error);\n      }\n    );\n  };\n\n  _parseSites(sites) {\n    this.sites = sites.map((site) => {\n      return {label: site.Nombre, value: site.Id};\n    });\n    this.model.idsitio = sites[0] && sites[0].Id;\n  }\n  login = () => {\n    this.loginInProgress = true;\n    this._loginSubscription = this._loginService.login(this.model).subscribe(\n      (data) => {\n        this.loginInProgress = false;\n        let {Token, Agente, Configuracion} = data;\n        Agente.IdSitio = this.model.idsitio;\n        this._authService.setToken(Token);\n        this._agentService.agent = Agente;\n        this._aboutService.about = Configuracion;\n        this._redirect();\n      },\n      (error) => {\n        this.loginInProgress = false;\n        this._handleInvalidLogin();\n      }\n    );\n  };\n  _handleInvalidLogin() {\n    this._notificationsService.error('Error de login',\n      'El email o la contrase침a es inv치lido'\n    );\n  }\n  setIdSitio = (idSitio) => {\n    this.model.idsitio = idSitio;\n  };\n  showSelector = () => {\n    return this.sites.length > 1;\n  };\n  ngOnDestroy() {\n    this._getSitesSubscription &&\n      !this._getSitesSubscription.closed &&\n      this._getSitesSubscription.unsubscribe();\n    this._loginSubscription &&\n      !this._loginSubscription.closed &&\n      this._loginSubscription.unsubscribe();\n  }\n}\n","import {RouterModule} from '@angular/router';\nimport {NgModule} from '@angular/core';\nimport {LoginComponent} from './login.component';\n\n@NgModule({\n  imports: [RouterModule.forChild([{path: '', component: LoginComponent}])],\n  exports: [RouterModule],\n})\nexport class LoginRoutingModule {}\n","import {Component, Input, Output, EventEmitter} from '@angular/core';\nimport html from './siteselector.component.html';\n\n@Component({\n  selector: 'tn-site-selector',\n  template: html,\n})\nexport class SiteSelectorComponent {\n  @Input() sites = [];\n  @Output() onSiteSelected = new EventEmitter();\n  selectSite = (event) => {\n    this.onSiteSelected.emit(event.value);\n  };\n}\n","import {NgModule} from '@angular/core';\nimport {LoginRoutingModule} from './login.routing';\nimport {LoginComponent} from './login.component';\nimport {SiteSelectorComponent} from './components';\nimport {TuneUpCoreModule} from '@tune-up/core';\n\n@NgModule({\n  imports: [TuneUpCoreModule, LoginRoutingModule],\n  declarations: [LoginComponent, SiteSelectorComponent],\n})\nexport class LoginModule {}\n"],"names":["validations","configService","addValidations","LoginService","Injectable","http","_http","_url","model","this","post","HttpClient","SitesService","email","get","LoginComponent","Component","ViewChild","route","router","loginService","sitesService","authService","agentService","aboutService","notificationsService","undefined","sites","loginInProgress","_returnUrl","onEmailFocusLost","_this","emailCtrl","valid","_getSitesSubscription","_sitesService","subscribe","data","length","_parseSites","error","_notificationsService","login","_loginSubscription","_loginService","Token","Agente","Configuracion","IdSitio","idsitio","_authService","setToken","_agentService","agent","_aboutService","about","_redirect","_handleInvalidLogin","setIdSitio","idSitio","showSelector","_route","_router","_setDefaulReturnUrl","_checkLogedIn","paramsReturnUrl","snapshot","queryParams","returnUrl","getToken","navigateByUrl","map","site","label","Nombre","value","Id","closed","unsubscribe","ActivatedRoute","Router","AuthService","AgentService","AboutService","NotificationsService","LoginRoutingModule","NgModule","RouterModule","forChild","path","component","SiteSelectorComponent","Input","Output","selectSite","event","onSiteSelected","emit","EventEmitter","LoginModule","TuneUpCoreModule"],"mappings":"61CAAO,IAAMA,mCAKM,gDAKA,wDAOA,kCCdnBC,gBAAcC,eAAeF,u6CCChBG,KADZC,mDAEaC,6BACLC,MAAQD,OACRE,KAAO,kEAERC,UACGC,KAAKH,MAAMI,KAAKD,KAAKF,KAAMC,uEALlBG,cADPR,WCAAS,KADZR,mDAEaC,6BACLC,MAAQD,OACRE,KAAO,iEAEVM,UACKJ,KAAKH,MAAMQ,IAAOL,KAAKF,UAASM,uEALvBF,cADPC,kjCCSAG,KALZC,sBACW,irDAEEb,EAAcS,OAWzBK,YAAU,qDAETC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,0CAjBFjB,kBACSkB,gBACGA,eACDA,QAEXC,cACAC,iBAAkB,OAClBC,WAAa,sDA0CbC,iBAAmB,WACZC,EAAKvB,MAAMK,OAAUkB,EAAKC,UAAUC,UAGpCC,sBAAwBH,EAAKI,cAAcrB,IAAIiB,EAAKvB,MAAMK,OAAOuB,UACpE,SAACC,KACMC,OAAS,GAAKP,EAAKQ,YAAYF,IAEtC,SAACG,KACMC,sBAAsBD,MAAM,kCAAmCA,YAW1EE,MAAQ,aACDd,iBAAkB,IAClBe,mBAAqBZ,EAAKa,cAAcF,MAAMX,EAAKvB,OAAO4B,UAC7D,SAACC,KACMT,iBAAkB,MAClBiB,EAAgCR,EAAhCQ,MAAOC,EAAyBT,EAAzBS,OAAQC,EAAiBV,EAAjBU,gBACbC,QAAUjB,EAAKvB,MAAMyC,UACvBC,aAAaC,SAASN,KACtBO,cAAcC,MAAQP,IACtBQ,cAAcC,MAAQR,IACtBS,aAEP,SAAChB,KACMZ,iBAAkB,IAClB6B,8BASXC,WAAa,SAACC,KACPnD,MAAMyC,QAAUU,QAEvBC,aAAe,kBACN7B,EAAKJ,MAAMW,OAAS,QA7EtBuB,OAAS3C,OACT4C,QAAU3C,OACVyB,cAAgBxB,OAChBe,cAAgBd,OAChB6B,aAAe5B,OACfgC,cAAgB9B,OAChB4B,cAAgB7B,OAChBkB,sBAAwBhB,0EAGxBsC,2BACAC,sFAGCC,EAAkBxD,KAAKoD,OAAOK,SAASC,YAAYC,eACpDvC,WACFoC,GACqB,WAApBA,GACoB,MAApBA,EAEEA,EADAxD,KAAKoB,iEAIPpB,KAAKyC,aAAamB,iBACfb,+DAIFM,QAAQQ,cAAc7D,KAAKoB,4DAgBtBF,QACLA,MAAQA,EAAM4C,IAAI,SAACC,UACdC,MAAOD,EAAKE,OAAQC,MAAOH,EAAKI,WAErCpE,MAAMyC,QAAUtB,EAAM,IAAMA,EAAM,GAAGiD,0EAqBrCnC,sBAAsBD,MAAM,iBAC/B,+FAUGN,wBACFzB,KAAKyB,sBAAsB2C,QAC5BpE,KAAKyB,sBAAsB4C,mBACxBnC,qBACFlC,KAAKkC,mBAAmBkC,QACzBpE,KAAKkC,mBAAmBmC,+jBAhGJ9C,mEAEf+C,iBACCC,SACM7E,EACAS,EACDqE,cACCC,eACAC,eACQC,wBAlBbrE,6BCLAsE,KAJZC,qBACWC,eAAaC,WAAWC,KAAM,GAAIC,UAAW3E,eAC7CwE,mFCCCI,KAJZ3E,sBACW,gIAIT4E,YACAC,sLACDC,WAAa,SAACC,KACPC,eAAeC,KAAKF,EAAMpB,qPAFN,IAAIuB,4BCCpBC,KAJZb,qBACWc,mBAAkBf,iBACbtE,EAAgB4E"}